name: Deploy - Full System

on:
  push:
    branches: [main]
    paths:
      - 'server.js'
      - 'public/**'
      - 'package.json'
      - 'docs/**'
      - 'data/**'
      - 'deploy-roles.sh'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  deploy-all:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Create deployment archive
        run: |
          echo "ğŸ“¦ Creating deployment archive..."
          mkdir -p data
          tar -czf deploy.tar.gz \
              --exclude='node_modules' \
              --exclude='.git' \
              --exclude='data/*.json' \
              server.js \
              package.json \
              public/ \
              docs/ \
              data/ \
              deploy-roles.sh \
              restart-minecraft.sh
          ls -lh deploy.tar.gz
      
      - name: ğŸ“¤ Upload to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          source: "deploy.tar.gz"
          target: "/tmp"
          timeout: 180s
          command_timeout: 120s
          overwrite: true
      
      - name: ğŸš€ Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 180s
          command_timeout: 120s
          script: |
            echo "ğŸš€ Starting deployment..."
            cd /opt/minecraft
            
            # Extract files (overwrites existing)
            echo "ğŸ“¦ Extracting files..."
            tar -xzf /tmp/deploy.tar.gz
            
            # Make scripts executable
            echo "ğŸ”§ Setting executable permissions..."
            chmod +x deploy-roles.sh 2>/dev/null || true
            chmod +x restart-minecraft.sh 2>/dev/null || true
            
            # Create data directory if not exists
            echo "ğŸ“ Ensuring data directory..."
            mkdir -p data
            
            # Install dependencies
            echo "ğŸ“¥ Installing dependencies..."
            npm install --production
            
            # Clean session locks
            echo "ğŸ§¹ Cleaning session locks..."
            rm -f world/session.lock 2>/dev/null || true
            rm -f world_nether/session.lock 2>/dev/null || true
            rm -f world_the_end/session.lock 2>/dev/null || true
            
            # Restart services
            echo "ğŸ”„ Restarting services..."
            pm2 restart minecraft-api || pm2 start server.js --name minecraft-api
            pm2 save
            
            # Cleanup
            rm -f /tmp/deploy.tar.gz
            
            echo "âœ… Deployment completed!"
            echo "ğŸ“Š Service status:"
            pm2 list
            echo "ğŸ” Checking API endpoints..."
            sleep 2
            curl -s http://localhost:3000/api/roles/players || echo "API check failed"
